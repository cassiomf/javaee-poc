name: Pull Request Checks

on:
  pull_request:
    branches: [ main ]

jobs:
  compile:
    name: Compile Project
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Compile with Maven
        run: mvn clean compile

  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: compile

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run tests with coverage
        run: mvn verify

      - name: List JaCoCo files
        run: ls -lhR target/site/jacoco || echo "JaCoCo directory not found"

      - name: Check if jacoco.xml exists
        run: |
          if [ -f target/site/jacoco/jacoco.xml ]; then
            echo "✅ Jacoco report found!"
          else
            echo "❌ Jacoco report not found!"
            ls -la target/site/jacoco || echo "Folder doesn't exist"
            exit 1
          fi

      - name: Upload jacoco.xml as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-xml
          path: target/site/jacoco/jacoco.xml

  sonar:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Run SonarCloud Scan
        run: mvn verify sonar:sonar
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io

  coverage:
    name: Check PR Coverage
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run tests with coverage on changed files
        run: |
          echo "Identifying changed files in the PR..."
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep '\.java$')
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No Java files were modified."
            exit 0
          fi

          echo "Running tests on modified files..."
          mvn clean verify -DskipTests=false -Djacoco.skip=false
          
      - name: List JaCoCo files
        run: ls -lhR target/site/jacoco || echo "JaCoCo directory not found"

      - name: Check if jacoco.xml exists
        run: |
          if [ -f target/site/jacoco/jacoco.xml ]; then
            echo "✅ Jacoco report found!"
          else
            echo "❌ Jacoco report not found!"
            ls -la target/site/jacoco || echo "Folder doesn't exist"
            exit 1
          fi

      - name: Upload jacoco.xml as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-xml
          path: target/site/jacoco/jacoco.xml

      - name: Check coverage on diff
        run: |
          echo "Verifying coverage on PR diff..."
          COVERAGE=$(xmllint --xpath 'string(//counter[@type="LINE"]/@covered)' target/site/jacoco/jacoco.xml)

          if [ $(echo "$COVERAGE < 70" | bc) -eq 1 ]; then
            echo "❌ Coverage is below 70%. Coverage: $COVERAGE"
            exit 1
          else
            echo "✅ Coverage is above 70%. Coverage: $COVERAGE"
          fi
